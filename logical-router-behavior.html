<script>
/*
	Logical Router Behavior
	Handles site routing using history api (pushing/popping)
	Created by: Kevin Ashcraft (@kevashcraft)
	Created on: 2015-12-22
	Last Edited: 2016-04-15


	Notes:
		The name of the loaded element is determined by parsing the address in the url par into a location array then looking up the element name in the pages object (located in the app-main.html file).
*/
/*
router based on the history api

	notes:
		-pages are defined in the pages object in the main object
		-location refers to an array of page names, url is the string found in the address bar
*/
Polymer.LogicalRouterBehavior = {

	Router: function() {

		// parse url into location array
		var location = window.location.pathname.substr(1).replace(/\/$/,'').toLowerCase().split('/');
		this.PageSet(location, 1);
		this.PopStateListener();
	},


	PageSet: function(location, replace) {

		if(location && LogicalApp.PageLocation) {
			if(location.every(function(page, i){ return page == LogicalApp.PageLocation[i] })) {
				return;
			}
		}


		var action = replace ? 'replace' : 'push',
				elementName = this.ElementNameFromLocation(location),
				element = LogicalApp.Element = document.createElement(elementName);

		pageURL = '/' + LogicalApp.PageLocation.join('/');

		this.PageController({
			ElementName: elementName,
			PageTitle: element.info.title,
			PageURL: pageURL,
			PageLocation: LogicalApp.PageLocation,
		}, action, element);

	},


	PageController: function(o, action, element) {

		if(action == 'pop') {
			LogicalApp.location = o.location;
			var element = LogicalApp.CurrentElement = document.createElement(o.element);
		}

		if(action == 'push')
			window.history.pushState(o, o.PageTitle, o.PageURL);
		else if(action == 'replace')
			window.history.replaceState(o, o.PageTitle, o.PageURL);

		document.title = o.PageTitle + " | " + LogicalApp.SiteTitle;
		this.header = o.PageTitle;


		// Remove old page, add new page
		var MainViewer = this.$.MainViewer,
				PreviousPage;

		if(PreviousPage = MainViewer.children[0]) {
			if(typeof PreviousPage.animateOut == 'function') {
				PreviousPage.animateOut();
			} else {
				MainViewer.removeChild(PreviousPage);
			}
		}

		MainViewer.appendChild(element);
		if(typeof element.animateOut == 'function') {
			element.animateIn();
		}

		// Remove previous Control Panel Content
		var ControlPanel = LogicalApp.$.ControlPanel;
		while(ControlPanel.firstChild) {
			ControlPanel.removeChild(ControlPanel.firstChild);
		}

		// Set Control Panel Content
		var ControlPanelContent;
		if(ControlPanelContent = element.$.ControlPanelContent) {
			ControlPanel.appendChild(ControlPanelContent);
		}



	},
	PopStateListener: function() {
		window.addEventListener('popstate', function(e){
			this.PageController(e.state, 'pop');
		}.bind(this));
	},

	ElementNameFromLocation: function(location) {

		if(location == undefined || location[0] == '') {
			location = [LogicalApp.PageDefault];
		}


		var page = LogicalApp.Pages[location[0]],
				pageLocation = [location[0]];

		for (var i = 1; i < 15; i++) {
			if(typeof page == 'string') {
				break;
			} else if (page[location[i]] == undefined) {
				page = page.default;
			}	else {
				page = page[location[i]];
				pageLocation.push(location[i]);
			}
		}


		LogicalApp.PageLocation = pageLocation;

		return page;

	},


}
</script>