<!-- 
Logical Site Base Behavior
	Description: Creates and maintains Site object
	Created by: Kevin Ashcraft
	Created on: 2015-12-22
	Last Modified: 2016-04-20
	Repo: https://github.com/LogicDudes/logical-site-behaviors
-->
<script>
Polymer.LogicalSiteBaseBehavior = {

	properties: {

		// holds the user information such as username, id, etc., and an isAuthed boolean to easily toggle hidden elements
		Site: {
			type: Object,
			notify: true,
			value: function() { return {} }
		},
	},

	observers: [
		'SiteTokenChanged(Site.Token)',
	],

	ready: function() {
	
		window.LogicalApp = this;


		this.StorageUnits = this.querySelectorAll('iron-localstorage');
		this.StorageUnitsReady = 0;

		if(this.StorageUnits.length > 0) {
			// add event listener to localstorage units for lists
			for( var i in this.StorageUnits) {
				if(!this.StorageUnits.hasOwnProperty(i)) break;
				this.StorageUnits[i].addEventListener('iron-localstorage-load', this.StorageUnitReady.bind(this));

				if(this.StorageUnits[i].name == 'Site') {
					this.StorageUnits[i].addEventListener('iron-localstorage-load-empty', this.SiteReset.bind(this));
				} else {
					this.StorageUnits[i].addEventListener('iron-localstorage-load-empty', this.StorageUnitReady.bind(this));
				}
			}
		} else {
			this.SiteReady();
		}

	},
	
	// fired when unit is ready, when all ready fires SiteReady
	StorageUnitReady: function() {
		this.StorageUnitsReady++;
		if(this.StorageUnitsReady == this.StorageUnits.length) {
			this.SiteReady();
		}
	},
	

	SiteReady: function() {
		this.SiteIsReady = true;
		this.fire('site-ready');
		this.Router();
	},
	
	// resets the site object
	SiteReset: function() {

		this.Site = {
			User: {
				roles: ' ',
			},
			Token: this.SiteToken,
			isAuthed: false,
			Pool: {},
		};

		if(!this.isReady) {
			this.StorageUnitReady();
		} else {
			// if reset occurred after site ready, then make sure page does not requre authentication
			if(LogicalApp.CurrentElement && LogicalApp.CurrentElement.info.RequiresAuth) {
				LogicalApp.PageSet([LogicalApp.PageDefault]);
			}
		}

	},

	SiteTokenChanged: function(n, o) {
	
		if(!this.SiteToken) {
			this.SiteToken = n;
		} else if (this.SiteToken != n) {
			this.SiteToken = n;
			this.SiteReset();
		}

	},

	Toast: function(message, duration, undo) {
		var Toast = this.$.Toast;
		Toast.duration = duration || 3500;
		Toast.text = message;
		Toast.show();
	},
	
};
</script>